@model QuanLyNhanLuc.Models.Entities.ThongTinNguoiDung
@using QuanLyNhanLuc.Constants

@{
    ViewData["Title"] = "Chi tiết nhân viên - " + Model.FullName;
    bool canManage = User.IsInRole(RoleNames.Admin) || User.IsInRole(RoleNames.HR);
}

<style>
    .hover-bg:hover { background-color: #f0f0f0; }
    .menu-link { transition: all 0.2s; }
    .menu-link.active { background-color: #e3f2fd !important; }
    
    /* Avatar styles */
    .header-section .rounded-circle {
        transition: all 0.3s ease;
    }
    .header-section .rounded-circle:hover {
        transform: scale(1.05);
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    .header-section label[for="avatarUpload"] {
        transition: all 0.2s;
    }
    .header-section label[for="avatarUpload"]:hover {
        background-color: #0056b3 !important;
        transform: scale(1.1);
    }
</style>

<!-- Hidden UserId for JavaScript -->
<input type="hidden" id="hiddenNguoiDungId" value="@Model.UserId" />

<!-- Breadcrumb -->
<nav aria-label="breadcrumb">
    <ol class="breadcrumb custom-breadcrumb mb-3">
        <li class="breadcrumb-item">
            <a class="text-decoration-none text-secondary" href="/">
                <i class="bi bi-house-door"></i>
            </a>
        </li>
        <li class="breadcrumb-item">
            <a class="text-decoration-none text-secondary" href="#">Hồ sơ nhân sự</a>
        </li>
        <li class="breadcrumb-item">
            <a class="text-decoration-none text-secondary" href="/NhanSu/DanhSachNhanVien">Danh sách nhân sự</a>
        </li>
        <li class="breadcrumb-item active text-primary" aria-current="page">Chi tiết nhân sự</li>
    </ol>
</nav>

<!-- Header Section with Overview Info -->
<div class="header-section mb-4">
    <div class="row g-4">
        <!-- Avatar Column -->
        <div class="col-md-2 text-center">
            <div class="position-relative d-inline-block">
                <img id="avatarPreview" 
                     src="@(string.IsNullOrEmpty(Model.ImageLink) ? "/Image/AvatarMIG.png" : "/Image/" + Model.ImageLink)" 
                     alt="Avatar" 
                     class="rounded-circle border shadow-sm" 
                     style="width: 120px; height: 120px; object-fit: cover;">
                @if (canManage)
                {
                    <label for="avatarUpload" class="position-absolute bottom-0 end-0 btn btn-sm btn-primary rounded-circle" 
                           style="width: 32px; height: 32px; padding: 0; cursor: pointer;" title="Đổi ảnh đại diện">
                        <i class="bi bi-camera-fill"></i>
                    </label>
                    <input type="file" id="avatarUpload" data-id="@Model.Id" accept="image/*" style="display: none;">
                }
            </div>
        </div>

        <!-- Info Column -->
        <div class="col-md-10">
            <div class="row g-4">
                <div class="col-12">
                    <h5 class="text-primary">@Model.FullName</h5>
                </div>
                
                <div class="col-md-2 text-secondary"><i class="fas fa-building"></i> Phòng ban:</div>
                <div class="col-md-4 text-primary">@(Model.PhongBan?.TenPhongBan ?? "Chưa phân công")</div>

                <div class="col-md-2 text-secondary"><i class="fas fa-calendar-alt"></i> Ngày sinh:</div>
                <div class="col-md-4 text-primary">@Model.BirthDay.ToString("dd/MM/yyyy")</div>

                <div class="col-md-2 text-secondary"><i class="fas fa-user-tie"></i> Vị trí:</div>
                <div class="col-md-4 text-primary">@(Model.ChucVu?.TenChucVu ?? "Chưa phân công")</div>

                <div class="col-md-2 text-secondary"><i class="fas fa-envelope"></i> Email:</div>
                <div class="col-md-4 text-primary">@(Model.User?.Email ?? "Chưa cập nhật")</div>

                <div class="col-md-2 text-secondary"><i class="fas fa-clipboard-list"></i> Trạng thái:</div>
                <div class="col-md-4">
                    @if (Model.Status == QuanLyNhanLuc.Models.Enums.Status.Approved)
                    {
                        <span class="text-success">Đang làm việc</span>
                    }
                    else if (Model.Status == QuanLyNhanLuc.Models.Enums.Status.Pending)
                    {
                        <span class="text-warning">Chờ duyệt</span>
                    }
                    else
                    {
                        <span class="text-secondary">Vô hiệu</span>
                    }
                </div>

                <div class="col-md-2 text-secondary"><i class="fas fa-phone"></i> Số điện thoại:</div>
                <div class="col-md-4 text-primary">@(Model.User?.PhoneNumber ?? "Chưa cập nhật")</div>
                
                @if (canManage)
                {
                    <div class="col-12 mt-2">
                        @if (Model.Status == QuanLyNhanLuc.Models.Enums.Status.Pending)
                        {
                            <button class="btn btn-success btn-sm me-2" id="btnDuyet" data-id="@Model.Id">
                                <i class="bi bi-check-circle me-1"></i>Duyệt
                            </button>
                        }
                     
                        <a asp-action="DanhSachNhanVien" class="btn btn-outline-secondary btn-sm">
                            <i class="bi bi-arrow-left me-1"></i>Quay lại
                        </a>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

<!-- Top Level Tabs -->
<ul class="nav nav-tabs mb-4">
    <li class="nav-item">
        <a class="nav-link text-primary menu-link-top" data-target-top="#thong-tin-chung" href="#">Thông tin chung</a>
    </li>
    <li class="nav-item">
        <a class="nav-link text-dark menu-link-top" data-target-top="#hop-dong-bao-hiem" href="#">Hợp đồng và bảo hiểm</a>
    </li>
    <li class="nav-item">
        <a class="nav-link text-dark menu-link-top" data-target-top="#khen-thuong-ky-luat" href="#">Khen thưởng kỷ luật</a>
    </li>
    <li class="nav-item">
        <a class="nav-link text-dark menu-link-top" data-target-top="#luong" href="#">Lương</a>
    </li>
</ul>

<!-- THÔNG TIN CHUNG -->
<section id="thong-tin-chung" class="content-section-top">
    <div class="row">
        <div class="col-md-3">
            <div class="bg-white rounded p-3 shadow-sm">
                <ul class="list-unstyled">
                    <li class="p-2">
                        <a href="#" class="text-decoration-none fw-medium d-block px-2 py-1 rounded hover-bg menu-link text-primary" data-target="ThongTinChung">Thông tin chung</a>
                    </li>
                    <li class="p-2">
                        <a href="#" class="text-decoration-none fw-medium d-block px-2 py-1 rounded hover-bg menu-link text-dark" data-target="ViTriCongTac">Vị trí công tác</a>
                    </li>
                    <li class="p-2">
                        <a href="#" class="text-decoration-none fw-medium d-block px-2 py-1 rounded hover-bg menu-link text-dark" data-target="TaiKhoanNganHang">Tài khoản ngân hàng</a>
                    </li>
                    <li class="p-2">
                        <a href="#" class="text-decoration-none fw-medium d-block px-2 py-1 rounded hover-bg menu-link text-dark" data-target="TrinhDo">Trình độ</a>
                    </li>
                    <li class="p-2">
                        <a href="#" class="text-decoration-none fw-medium d-block px-2 py-1 rounded hover-bg menu-link text-dark" data-target="HoKhau">Hộ khẩu</a>
                    </li>
                </ul>
            </div>
        </div>
        <div class="col-md-9">
            <!-- Thông tin chung -->
            <section id="ThongTinChung" class="content-section">
                <div class="card mb-4 border-0 shadow-sm">
                    <div class="card-header bg-white d-flex justify-content-between align-items-center border-0">
                        <h5 class="card-title mb-0 text-primary">Thông tin tài khoản</h5>
                        @if (canManage)
                        {
                            <i class="bi bi-pen text-muted" style="cursor:pointer" onclick="loadThongTinTaiKhoan('@Model.UserId')"></i>
                        }
                    </div>
                    <div class="card-body">
                        <p class="mb-1 text-secondary">Mã nhân viên</p>
                        <p class="text-primary">@(Model.User?.MaNhanVien ?? "Chưa cập nhật")</p>

                        <div class="row">
                            <div class="col text-secondary">Email</div>
                            <div class="col text-secondary text-end">Số điện thoại</div>
                        </div>
                        <div class="row">
                            <div class="col">
                                <a href="mailto:@Model.User?.Email" class="text-primary text-decoration-none">@(Model.User?.Email ?? "Chưa cập nhật")</a>
                            </div>
                            <div class="col text-primary text-end">@(Model.User?.PhoneNumber ?? "Chưa cập nhật")</div>
                        </div>
                    </div>
                </div>

                <div class="card mb-4 border-0 shadow-sm">
                    <div class="card-header bg-white d-flex justify-content-between align-items-center border-0">
                        <h5 class="card-title mb-0 text-primary">Thông tin cơ bản</h5>
                        @if (canManage)
                        {
                            <i class="bi bi-pen text-muted" style="cursor:pointer" onclick="loadThongTinCoBan('@Model.Id')"></i>
                        }
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <p class="text-secondary">Tên nhân viên</p>
                                <p class="text-primary">@Model.FullName</p>
                            </div>
                            <div class="col-md-6">
                                <p class="text-secondary">CMND/CCCD</p>
                                <p class="text-primary">@(Model.IdentityNumber ?? "Chưa cập nhật")</p>
                            </div>
                            <div class="col-md-6">
                                <p class="text-secondary">Ngày sinh</p>
                                <p class="text-primary">@Model.BirthDay.ToString("dd/MM/yyyy")</p>
                            </div>
                            <div class="col-md-6">
                                <p class="text-secondary">Giới tính</p>
                                <p class="text-primary">@Model.GioiTinhStxt</p>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Vị trí công tác -->
            <section id="ViTriCongTac" class="content-section d-none">
                <div class="card border-0 p-3 shadow-sm">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="text-primary fw-bold">Thông tin công tác</h5>
                        @if (canManage)
                        {
                            <i class="bi bi-pen" style="cursor:pointer" onclick="loadViTriCongTac('@Model.Id')"></i>
                        }
                    </div>
                    <div class="row mt-2">
                        <div class="col-md-6">
                            <p class="mb-1">Phòng ban</p>
                            <p class="text-primary">@(Model.Department?.TenPhongBan ?? "Chưa phân công")</p>
                        </div>
                        <div class="col-md-6">
                            <p class="mb-1">Chức vụ</p>
                            <p class="text-primary">@(Model.ChucVu?.TenChucVu ?? "Chưa phân công")</p>
                        </div>
                        <div class="col-md-6">
                            <p class="mb-1">Loại nhân viên</p>
                            <p class="text-primary">@(Model.NhanSuTypeStxt ?? "Chưa cập nhật")</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Tài khoản ngân hàng -->
            <section id="TaiKhoanNganHang" class="content-section d-none">
                <div class="card border-0 p-3 shadow-sm">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="text-primary fw-bold">Tài khoản ngân hàng</h5>
                        @if (canManage)
                        {
                            <i class="bi bi-pen" style="cursor:pointer" onclick="loadBankInfo('@Model.UserId')"></i>
                        }
                    </div>
                    <div class="row mt-3" id="bankInfoContent">
                        <p class="text-muted">Đang tải...</p>
                    </div>
                </div>
            </section>

            <!-- Trình độ -->
            <section id="TrinhDo" class="content-section d-none">
                <div class="card border-0 p-3 shadow-sm mb-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="text-primary fw-bold">Trình độ</h5>
                        @if (canManage)
                        {
                            <i class="bi bi-pen" style="cursor:pointer" onclick="loadTrinhDo('@Model.UserId')"></i>
                        }
                    </div>
                    <div class="row mt-3" id="trinhDoContent">
                        <p class="text-muted">Đang tải...</p>
                    </div>
                </div>

                <div class="card border-0 p-3 shadow-sm">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="text-primary fw-bold">Đào tạo, bồi dưỡng chuyên môn</h5>
                        @if (canManage)
                        {
                            <button class="btn btn-primary btn-sm" onclick="openAddDaoTao('@Model.UserId')">+ Thêm mới</button>
                        }
                    </div>
                    <div class="table-responsive mt-3">
                        <table class="table table-bordered">
                            <thead class="text-primary">
                                <tr>
                                    <th>STT</th>
                                    <th>Tên trường/Tổ chức</th>
                                    <th>Ngành học hoặc tên lớp học</th>
                                    <th>Thời gian học</th>
                                    <th>Hình thức học</th>
                                    <th>Văn bằng chứng chỉ</th>
                                    <th>Hành động</th>
                                </tr>
                            </thead>
                            <tbody id="daoTaoTableBody">
                                <tr><td colspan="7" class="text-center text-muted">Đang tải...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Hộ khẩu -->
            <section id="HoKhau" class="content-section d-none">
                <div class="card border-0 p-3 shadow-sm">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="text-primary fw-bold">Quan hệ gia đình</h5>
                        @if (canManage)
                        {
                            <button class="btn btn-primary btn-sm" onclick="openAddFamily('@Model.UserId')">+ Thêm mới</button>
                        }
                    </div>
                    <div class="row mt-3">
                        <table class="table table-bordered">
                            <thead>
                                <tr>
                                    <th class="text-primary">STT</th>
                                    <th class="text-primary">Tên người thân</th>
                                    <th class="text-primary">Giới tính</th>
                                    <th class="text-primary">Ngày sinh</th>
                                    <th class="text-primary">Điện thoại</th>
                                    <th class="text-primary">Quan hệ với chủ hộ</th>
                                    <th class="text-primary">Hành động</th>
                                </tr>
                            </thead>
                            <tbody id="familyTableBody">
                                <tr><td colspan="7" class="text-center text-muted">Đang tải...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>
        </div>
    </div>
</section>

<!-- HỢP ĐỒNG VÀ BẢO HIỂM -->
<section id="hop-dong-bao-hiem" class="content-section-top d-none">
    <div class="row">
        <div class="col-md-3">
            <div class="bg-white rounded p-3 shadow-sm">
                <ul class="list-unstyled">
                    <li class="p-2">
                        <a href="#" class="text-decoration-none fw-medium d-block px-2 py-1 rounded hover-bg menu-link text-primary" data-target="HopDong">Hợp đồng</a>
                    </li>
                    <li class="p-2">
                        <a href="#" class="text-decoration-none fw-medium d-block px-2 py-1 rounded hover-bg menu-link text-dark" data-target="ThongTinBaoHiem">Thông tin bảo hiểm</a>
                    </li>
                </ul>
            </div>
        </div>
        <div class="col-md-9">
            <!-- Hợp đồng -->
            <section id="HopDong" class="content-section">
                <div class="card mb-4 border-0 shadow-sm">
                    <div class="card-header bg-white d-flex justify-content-between align-items-center border-0">
                        <h5 class="card-title mb-0 text-primary">Hợp đồng lao động</h5>
                        @if (canManage)
                        {
                            <button class="btn btn-primary btn-sm" onclick="openAddHopDong('@Model.UserId')">+ Thêm mới</button>
                        }
                    </div>
                    <div class="card-body">
                        <table class="table table-bordered">
                            <thead>
                                <tr>
                                    <th class="text-primary">STT</th>
                                    <th class="text-primary">Số hợp đồng</th>
                                    <th class="text-primary">Loại hợp đồng</th>
                                    <th class="text-primary">Ngày ký hợp đồng</th>
                                    <th class="text-primary">Ngày bắt đầu</th>
                                    <th class="text-primary">Ngày kết thúc</th>
                                    <th class="text-primary">Hành động</th>
                                </tr>
                            </thead>
                            <tbody id="hopDongTableBody">
                                <tr><td colspan="7" class="text-center text-muted">Đang tải...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Thông tin bảo hiểm -->
            <section id="ThongTinBaoHiem" class="content-section d-none">
                <div class="card mb-4 border-0 shadow-sm">
                    <div class="card-header bg-white d-flex justify-content-between align-items-center border-0">
                        <h5 class="card-title mb-0 text-primary">Bảo hiểm xã hội</h5>
                        @if (canManage)
                        {
                            <i class="bi bi-pen" style="cursor:pointer" onclick="openEditBaoHiem('BHXH', '@Model.UserId')"></i>
                        }
                    </div>
                    <div class="card-body" id="bhxhContent">
                        <p class="text-muted">Đang tải...</p>
                    </div>
                </div>

                <div class="card mb-4 border-0 shadow-sm">
                    <div class="card-header bg-white d-flex justify-content-between align-items-center border-0">
                        <h5 class="card-title mb-0 text-primary">Bảo hiểm thất nghiệp</h5>
                        @if (canManage)
                        {
                            <i class="bi bi-pen" style="cursor:pointer" onclick="openEditBaoHiem('BHTN', '@Model.UserId')"></i>
                        }
                    </div>
                    <div class="card-body" id="bhtnContent">
                        <p class="text-muted">Đang tải...</p>
                    </div>
                </div>

                <div class="card mb-4 border-0 shadow-sm">
                    <div class="card-header bg-white d-flex justify-content-between align-items-center border-0">
                        <h5 class="card-title mb-0 text-primary">Bảo hiểm y tế</h5>
                        @if (canManage)
                        {
                            <i class="bi bi-pen" style="cursor:pointer" onclick="openEditBaoHiem('BHYT', '@Model.UserId')"></i>
                        }
                    </div>
                    <div class="card-body" id="bhytContent">
                        <p class="text-muted">Đang tải...</p>
                    </div>
                </div>
            </section>
        </div>
    </div>
</section>

<!-- KHEN THƯỞNG KỶ LUẬT -->
<section id="khen-thuong-ky-luat" class="content-section-top d-none">
    <div class="card border-0 p-3 shadow-sm mb-3">
        <div class="d-flex justify-content-between align-items-center">
            <h5 class="text-primary fw-bold">Khen thưởng</h5>
            @if (canManage)
            {
                <button class="btn btn-primary btn-sm" onclick="openAddKhenThuong('@Model.UserId')">+ Thêm mới</button>
            }
        </div>
        <div class="row mt-3">
            <table class="table table-bordered">
                <thead>
                    <tr>
                        <th class="text-primary">STT</th>
                        <th class="text-primary">Nội dung khen thưởng</th>
                        <th class="text-primary">Hình thức</th>
                        <th class="text-primary">Ngày ký</th>
                        <th class="text-primary">Số quyết định</th>
                        <th class="text-primary">Giá trị khen thưởng</th>
                        <th class="text-primary">Hành động</th>
                    </tr>
                </thead>
                <tbody id="khenThuongTableBody">
                    <tr><td colspan="7" class="text-center text-muted">Đang tải...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <div class="card border-0 p-3 shadow-sm">
        <div class="d-flex justify-content-between align-items-center">
            <h5 class="text-primary fw-bold">Kỷ luật</h5>
            @if (canManage)
            {
                <button class="btn btn-primary btn-sm" onclick="openAddKyLuat('@Model.UserId')">+ Thêm mới</button>
            }
        </div>
        <div class="row mt-3">
            <table class="table table-bordered">
                <thead>
                    <tr>
                        <th class="text-primary">STT</th>
                        <th class="text-primary">Nội dung kỉ luật</th>
                        <th class="text-primary">Ngày ra quyết định</th>
                        <th class="text-primary">Hình thức kỉ luật</th>
                        <th class="text-primary">Lý do kỉ luật</th>
                        <th class="text-primary">Hành động</th>
                    </tr>
                </thead>
                <tbody id="kyLuatTableBody">
                    <tr><td colspan="6" class="text-center text-muted">Đang tải...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</section>

<!-- LƯƠNG -->
<section id="luong" class="content-section-top d-none">
    <div class="container-fluid">
        <h4 class="text-primary">Bảng lương</h4>
        <div class="row mb-3">
            <div class="col-md-3">
                <select class="form-select" id="yearSelect">
                    <option>--Chọn năm--</option>
                </select>
            </div>
            <div class="col-md-3">
                <select class="form-select" id="monthSelect">
                    <option>--Chọn tháng--</option>
                </select>
            </div>
            <div class="col-md-2">
                <button class="btn btn-primary w-100" onclick="searchLuong()">
                    <i class="fas fa-search me-2"></i>Tìm kiếm
                </button>
            </div>
        </div>

        <table class="table table-bordered text-center">
            <thead class="table-light">
                <tr>
                    <th>STT</th>
                    <th>Tháng/Năm</th>
                    <th>Lương cơ bản</th>
                    <th>Phụ cấp</th>
                    <th>Khấu trừ</th>
                    <th>Thực lĩnh</th>
                    <th>Trạng thái</th>
                </tr>
            </thead>
            <tbody id="luongTableBody">
                <tr><td colspan="7" class="text-center text-muted">Đang tải...</td></tr>
            </tbody>
        </table>
    </div>
</section>

@Html.AntiForgeryToken()

<partial name="~/Views/Modals/_ModalSuaThongTinCoBan.cshtml" model="Model" />
<partial name="~/Views/Modals/_ModalSuaThongTinTaiKhoan.cshtml" model="Model" />
<partial name="~/Views/Modals/_ModalSuaThongTinKhac.cshtml" />
<partial name="~/Views/Modals/_ModalSuaViTriCongTac.cshtml" model="Model" />
<partial name="~/Views/Modals/_ModalSuaThongTinNganHang.cshtml" />
<partial name="~/Views/Modals/_ModalSuaTrinhDo.cshtml" />
<partial name="~/Views/Modals/_ModalDaoTao.cshtml" />
<partial name="~/Views/Modals/_ModalChiTietQuanHeGiaDinh.cshtml" />
<partial name="~/Views/Modals/_ModalThemQuanHeGiaDinh.cshtml" />
<partial name="~/Views/Modals/_ModalXacNhan.cshtml" />
<partial name="~/Views/Modals/_ModalHopDong.cshtml" />
<partial name="~/Views/Modals/_ModalKhenThuong.cshtml" />
<partial name="~/Views/Modals/_ModalKyLuat.cshtml" />
<partial name="~/Views/Modals/_ModalBaoHiem.cshtml" />

@section Scripts {
    <script src="~/js/chi-tiet-nhan-vien.js" asp-append-version="true"></script>
}
