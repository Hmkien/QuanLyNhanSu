using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using QuanLyNhanLuc.Data;
using QuanLyNhanLuc.Models.Entities;
using QuanLyNhanLuc.Models.Enums;
using System.Security.Claims;

namespace QuanLyNhanLuc.Controllers;

[Authorize]
public class ThuTucHanhChinhController : Controller
{
    private readonly QLNLContext _context;
    private readonly IWebHostEnvironment _environment;

    public ThuTucHanhChinhController(QLNLContext context, IWebHostEnvironment environment)
    {
        _context = context;
        _environment = environment;
    }

    private async Task<(NhanSu? NhanSu, List<string> Roles, bool IsAdmin, bool IsGiamDoc, bool IsTruongPhong, bool IsKeToan)> GetCurrentUserInfo()
    {
        string? userId = User.FindFirstValue(ClaimTypes.NameIdentifier);
        var user = await _context.Users
            .Include(u => u.ThongTinNguoiDung)
            .ThenInclude(t => t!.NhanSu)
            .ThenInclude(n => n!.PhongBan)
            .FirstOrDefaultAsync(u => u.Id == userId);

        List<string> roles = User.Claims
            .Where(c => c.Type == ClaimTypes.Role)
            .Select(c => c.Value)
            .ToList();

        var nhanSu = user?.ThongTinNguoiDung?.NhanSu;

        bool isAdmin = roles.Contains("Admin") || roles.Contains("QuanLyNhanSu");
        bool isGiamDoc = roles.Contains("GiamDoc")
        bool isTruongPhong = roles.Contains("TruongPhong");
        bool isKeToan = roles.Contains("KeToan");

        return (nhanSu, roles, isAdmin, isGiamDoc, isTruongPhong, isKeToan);
    }

    public async Task<IActionResult> Index(string? search, int? loaiThuTuc, int? trangThai, int page = 1, int pageSize = 10)
    {
        (NhanSu? nhanSu, List<string>? roles, bool isAdmin, bool isGiamDoc, bool isTruongPhong, bool isKeToan) = await GetCurrentUserInfo();

        IQueryable<ThuTucHanhChinh> query = _context.ThuTucHanhChinhs
            .Include(t => t.NhanSu)
            .ThenInclude(n => n.PhongBan)
            .AsNoTracking()
            .AsQueryable();

        // Phân quyền xem
        if (!isAdmin && !isGiamDoc)
        {
            if (isTruongPhong && nhanSu?.PhongBanId != null)
            {
                // Trưởng phòng xem nhân viên phòng mình
                query = query.Where(t => t.NhanSu.PhongBanId == nhanSu.PhongBanId);
            }
            else if (isKeToan)
            {
                // Kế toán xem những đơn đã được trưởng phòng duyệt
                query = query.Where(t => (int)t.TrangThai >= (int)TrangThaiThuTuc.TruongPhongDuyet);
            }
            else if (nhanSu != null)
            {
                // Nhân viên chỉ xem đơn của mình
                query = query.Where(t => t.NhanSuId == nhanSu.Id);
            }
            else
            {
                query = query.Where(t => false); // Không có quyền
            }
        }

        // Tìm kiếm
        if (!string.IsNullOrWhiteSpace(search))
        {
            query = query.Where(t => t.NhanSu.HoTen.Contains(search) ||
                                    t.MaThuTuc.Contains(search) ||
                                    t.LyDo.Contains(search));
        }

        // Lọc loại thủ tục
        if (loaiThuTuc.HasValue)
        {
            query = query.Where(t => (int)t.LoaiThuTuc == loaiThuTuc.Value);
        }

        // Lọc trạng thái
        if (trangThai.HasValue)
        {
            query = query.Where(t => (int)t.TrangThai == trangThai.Value);
        }

        query = query.OrderByDescending(t => t.NgayNop);
        int total = await query.CountAsync();
        List<ThuTucHanhChinh> items = await query.Skip((page - 1) * pageSize).Take(pageSize).ToListAsync();

        ViewBag.TotalPages = (int)Math.Ceiling(total / (double)pageSize);
        ViewBag.TotalItems = total;
        ViewBag.CurrentPage = page;
        ViewBag.PageSize = pageSize;
        ViewBag.Search = search;
        ViewBag.LoaiThuTuc = loaiThuTuc;
        ViewBag.TrangThai = trangThai;

        // Permission flags
        ViewBag.CanCreate = nhanSu != null;
        ViewBag.CanApprove = isTruongPhong || isKeToan || isGiamDoc || isAdmin;
        ViewBag.IsTruongPhong = isTruongPhong;
        ViewBag.IsKeToan = isKeToan;
        ViewBag.IsGiamDoc = isGiamDoc;
        ViewBag.IsAdmin = isAdmin;
        ViewBag.CurrentNhanSuId = nhanSu?.Id;

        return View(items);
    }

    [HttpGet]
    public async Task<IActionResult> GetChiTiet(Guid id)
    {
        ThuTucHanhChinh? item = await _context.ThuTucHanhChinhs
            .Include(t => t.NhanSu)
            .ThenInclude(n => n.PhongBan)
            .FirstOrDefaultAsync(t => t.Id == id);

        if (item == null)
        {
            return NotFound();
        }

        (NhanSu? nhanSu, List<string>? roles, bool isAdmin, bool isGiamDoc, bool isTruongPhong, bool isKeToan) = await GetCurrentUserInfo();

        // Check permission
        if (!isAdmin && !isGiamDoc)
        {
            if (isTruongPhong && item.NhanSu.PhongBanId != nhanSu?.PhongBanId)
            {
                return Forbid();
            }

            if (isKeToan && (int)item.TrangThai < (int)TrangThaiThuTuc.TruongPhongDuyet)
            {
                return Forbid();
            }

            if (!isTruongPhong && !isKeToan && item.NhanSuId != nhanSu?.Id)
            {
                return Forbid();
            }
        }

        ViewBag.CanEdit = item.TrangThai == TrangThaiThuTuc.NopDon && item.NhanSuId == nhanSu?.Id;
        ViewBag.CanApprove = (isTruongPhong && item.TrangThai == TrangThaiThuTuc.NopDon) ||
                            (isKeToan && item.TrangThai == TrangThaiThuTuc.TruongPhongDuyet) ||
                            (isGiamDoc && item.TrangThai == TrangThaiThuTuc.KeToanDuyet) ||
                            isAdmin;
        ViewBag.CanReject = ViewBag.CanApprove;

        return PartialView("_ChiTietPartial", item);
    }

    [HttpPost]
    public async Task<IActionResult> CreateAjax([FromForm] ThuTucHanhChinh model, IFormFile? tepDinhKem)
    {
        (NhanSu? nhanSu, List<string> _, bool _, bool _, bool _, bool _) = await GetCurrentUserInfo();
        if (nhanSu == null)
        {
            return Json(new { success = false, message = "Không tìm thấy thông tin nhân sự" });
        }

        if (string.IsNullOrWhiteSpace(model.LyDo))
        {
            return Json(new { success = false, message = "Lý do không được để trống" });
        }

        // Auto generate MaThuTuc
        int count = await _context.ThuTucHanhChinhs.CountAsync();
        model.MaThuTuc = $"TT{DateTime.Now:yyyyMMdd}{count + 1:D4}";

        model.Id = Guid.NewGuid();
        model.NhanSuId = nhanSu.Id;
        model.NgayNop = DateTime.Now;
        model.TrangThai = TrangThaiThuTuc.NopDon;

        // Upload file
        if (tepDinhKem != null && tepDinhKem.Length > 0)
        {
            string uploadsFolder = Path.Combine(_environment.WebRootPath, "uploads", "thu-tuc");
            Directory.CreateDirectory(uploadsFolder);
            string fileName = $"{Guid.NewGuid()}{Path.GetExtension(tepDinhKem.FileName)}";
            string filePath = Path.Combine(uploadsFolder, fileName);
            using (FileStream stream = new(filePath, FileMode.Create))
            {
                await tepDinhKem.CopyToAsync(stream);
            }
            model.TepDinhKem = $"/uploads/thu-tuc/{fileName}";
        }

        _context.ThuTucHanhChinhs.Add(model);
        await _context.SaveChangesAsync();

        return Json(new { success = true });
    }

    [HttpPost]
    public async Task<IActionResult> EditAjax([FromForm] ThuTucHanhChinh model, IFormFile? tepDinhKem)
    {
        ThuTucHanhChinh? item = await _context.ThuTucHanhChinhs.FindAsync(model.Id);
        if (item == null)
        {
            return Json(new { success = false, message = "Không tìm thấy thủ tục" });
        }

        (NhanSu? nhanSu, List<string> _, bool _, bool _, bool _, bool _) = await GetCurrentUserInfo();

        // Chỉ cho phép sửa khi chưa gửi và là người tạo
        if (item.TrangThai != TrangThaiThuTuc.NopDon || item.NhanSuId != nhanSu?.Id)
        {
            return Json(new { success = false, message = "Không thể sửa thủ tục này" });
        }

        item.LoaiThuTuc = model.LoaiThuTuc;
        item.LyDo = model.LyDo;
        item.NgayBatDau = model.NgayBatDau;
        item.NgayKetThuc = model.NgayKetThuc;
        item.SoNgay = model.SoNgay;
        item.GhiChu = model.GhiChu;

        // Upload file
        if (tepDinhKem != null && tepDinhKem.Length > 0)
        {
            // Delete old file
            if (!string.IsNullOrEmpty(item.TepDinhKem))
            {
                string oldFilePath = Path.Combine(_environment.WebRootPath, item.TepDinhKem.TrimStart('/'));
                if (System.IO.File.Exists(oldFilePath))
                {
                    System.IO.File.Delete(oldFilePath);
                }
            }

            string uploadsFolder = Path.Combine(_environment.WebRootPath, "uploads", "thu-tuc");
            Directory.CreateDirectory(uploadsFolder);
            string fileName = $"{Guid.NewGuid()}{Path.GetExtension(tepDinhKem.FileName)}";
            string filePath = Path.Combine(uploadsFolder, fileName);
            using (FileStream stream = new(filePath, FileMode.Create))
            {
                await tepDinhKem.CopyToAsync(stream);
            }
            item.TepDinhKem = $"/uploads/thu-tuc/{fileName}";
        }

        await _context.SaveChangesAsync();
        return Json(new { success = true });
    }

    [HttpPost]
    public async Task<IActionResult> DeleteAjax([FromForm] Guid id)
    {
        ThuTucHanhChinh? item = await _context.ThuTucHanhChinhs.FindAsync(id);
        if (item == null)
        {
            return Json(new { success = false, message = "Không tìm thấy thủ tục" });
        }

        (NhanSu? nhanSu, List<string> _, bool _, bool _, bool _, bool _) = await GetCurrentUserInfo();

        // Chỉ cho phép xóa khi chưa gửi và là người tạo
        if (item.TrangThai != TrangThaiThuTuc.NopDon || item.NhanSuId != nhanSu?.Id)
        {
            return Json(new { success = false, message = "Không thể xóa thủ tục này" });
        }

        // Delete file
        if (!string.IsNullOrEmpty(item.TepDinhKem))
        {
            string filePath = Path.Combine(_environment.WebRootPath, item.TepDinhKem.TrimStart('/'));
            if (System.IO.File.Exists(filePath))
            {
                System.IO.File.Delete(filePath);
            }
        }

        _context.ThuTucHanhChinhs.Remove(item);
        await _context.SaveChangesAsync();
        return Json(new { success = true });
    }

    [HttpPost]
    public async Task<IActionResult> ApproveAjax([FromForm] Guid id, [FromForm] string? ghiChu)
    {
        ThuTucHanhChinh? item = await _context.ThuTucHanhChinhs
            .Include(t => t.NhanSu)
            .FirstOrDefaultAsync(t => t.Id == id);

        if (item == null)
        {
            return Json(new { success = false, message = "Không tìm thấy thủ tục" });
        }

        (NhanSu? nhanSu, List<string> _, bool isAdmin, bool isGiamDoc, bool isTruongPhong, bool isKeToan) = await GetCurrentUserInfo();

        // Check permission and update status
        if (isTruongPhong && item.TrangThai == TrangThaiThuTuc.NopDon && item.NhanSu.PhongBanId == nhanSu?.PhongBanId)
        {
            item.TrangThai = TrangThaiThuTuc.TruongPhongDuyet;
        }
        else if (isKeToan && item.TrangThai == TrangThaiThuTuc.TruongPhongDuyet)
        {
            item.TrangThai = TrangThaiThuTuc.KeToanDuyet;
        }
        else if (isGiamDoc && item.TrangThai == TrangThaiThuTuc.KeToanDuyet)
        {
            item.TrangThai = TrangThaiThuTuc.HoanThanh;
        }
        else if (isAdmin)
        {
            item.TrangThai = TrangThaiThuTuc.HoanThanh;
        }
        else
        {
            return Json(new { success = false, message = "Không có quyền duyệt" });
        }

        item.NguoiDuyet = User.Identity?.Name;
        item.NgayDuyet = DateTime.Now;
        item.GhiChu = ghiChu;

        await _context.SaveChangesAsync();
        return Json(new { success = true });
    }

    [HttpPost]
    public async Task<IActionResult> RejectAjax([FromForm] Guid id, [FromForm] string? ghiChu)
    {
        ThuTucHanhChinh? item = await _context.ThuTucHanhChinhs
            .Include(t => t.NhanSu)
            .FirstOrDefaultAsync(t => t.Id == id);

        if (item == null)
        {
            return Json(new { success = false, message = "Không tìm thấy thủ tục" });
        }

        (NhanSu? nhanSu, List<string> _, bool isAdmin, bool isGiamDoc, bool isTruongPhong, bool isKeToan) = await GetCurrentUserInfo();

        // Check permission
        bool canReject = (isTruongPhong && item.NhanSu.PhongBanId == nhanSu?.PhongBanId) ||
                       isKeToan || isGiamDoc || isAdmin;

        if (!canReject)
        {
            return Json(new { success = false, message = "Không có quyền từ chối" });
        }

        item.TrangThai = TrangThaiThuTuc.TuChoi;
        item.NguoiDuyet = User.Identity?.Name;
        item.NgayDuyet = DateTime.Now;
        item.GhiChu = ghiChu;

        await _context.SaveChangesAsync();
        return Json(new { success = true });
    }
}
