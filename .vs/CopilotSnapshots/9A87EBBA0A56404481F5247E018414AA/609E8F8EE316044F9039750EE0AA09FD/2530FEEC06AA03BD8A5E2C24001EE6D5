using Microsoft.AspNetCore.Identity;
using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Mvc.Rendering;
using Microsoft.EntityFrameworkCore;
using QuanLyNhanLuc.Data;
using QuanLyNhanLuc.Extensions;
using QuanLyNhanLuc.Models.Entities;
using QuanLyNhanLuc.Models.ViewModels;

namespace QuanLyNhanLuc.Controllers;

public class NhanSuController : Controller
{
    private readonly QLNLContext _context;
    private readonly UserManager<NguoiDung> _userManager;
    public NhanSuController(QLNLContext context, UserManager<NguoiDung> userManager)
    {
        _context = context;
        _userManager = userManager;
    }
    public async Task<IActionResult> DanhSachNhanVien()
    {
        List<NhanVienListVM> nhanvien = await _context.ThongTinNguoiDungs
            .Include(t => t.Department)
            .Include(t => t.ChucVu)
            .Include(t => t.User)
            .Where(t => t.NhanSuType != NhanSuType.ThucTapSinh)
            .Select(ttnd => new NhanVienListVM
            {
                Id = ttnd.Id,
                FullName = ttnd.FullName,
                IdentityNumber = ttnd.IdentityNumber,
                GioiTinhStxt = ttnd.GioiTinhStxt,
                DepartmentName = ttnd.Department != null ? ttnd.Department.TenPhongBan : string.Empty,
                PositionName = ttnd.ChucVu != null ? ttnd.ChucVu.TenChucVu : string.Empty,
                Email = ttnd.User != null ? ttnd.User.Email : string.Empty,
                PhoneNumber = ttnd.User != null ? ttnd.User.PhoneNumber : string.Empty
            })
            .ToListAsync();

        return View(nhanvien);
    }
    public async Task<IActionResult> DanhSachThucTap()
    {
        List<NhanVienListVM> thucTapSinh = await _context.ThongTinNguoiDungs
            .Include(t => t.Department)
            .Include(t => t.ChucVu)
            .Include(t => t.User)
            .Where(t => t.NhanSuType == NhanSuType.ThucTapSinh)
            .Select(ttnd => new NhanVienListVM
            {
                Id = ttnd.Id,
                FullName = ttnd.FullName,
                IdentityNumber = ttnd.IdentityNumber,
                GioiTinhStxt = ttnd.GioiTinhStxt,
                DepartmentName = ttnd.Department != null ? ttnd.Department.TenPhongBan : string.Empty,
                PositionName = ttnd.ChucVu != null ? ttnd.ChucVu.TenChucVu : string.Empty,
                Email = ttnd.User != null ? ttnd.User.Email : string.Empty,
                PhoneNumber = ttnd.User != null ? ttnd.User.PhoneNumber : string.Empty
            })
            .ToListAsync();

        return View(thucTapSinh);
    }
    public async Task<IActionResult> GetModalThemNhanSu()
    {
        ThemNhanVienVM model = new();
        List<Department> departments = await _context.Departments.OrderBy(d => d.TenPhongBan).ToListAsync();
        List<ChucVu> chucVus = await _context.ChucVus.OrderBy(c => c.TenChucVu).ToListAsync();
        model.Departments = new SelectList(departments, "Id", "TenPhongBan");
        model.ChucVus = new SelectList(chucVus, "Id", "TenChucVu");
        return PartialView("~/Views/Modals/_ModalThemNhanSu.cshtml", model);
    }
    public IActionResult ChiTietNhanVien()
    {
        return View();
    }
    public IActionResult GetModalConfirmDelete(Guid id)
    {
        return PartialView("~/Views/Modals/_ModalConfirmDelete.cshtml", id);
    }
    [HttpPost]
    [ValidateAntiForgeryToken]
    public async Task<IActionResult> XoaNhanVien(Guid id)
    {
        try
        {
            ThongTinNguoiDung? nhanVien = await _context.ThongTinNguoiDungs
                .Include(x => x.User)
                .FirstOrDefaultAsync(x => x.Id == id);

            if (nhanVien == null)
            {
                return NotFound();
            }

            // Xóa thông tin người dùng
            _ = _context.ThongTinNguoiDungs.Remove(nhanVien);

            // Xóa người dùng
            if (nhanVien.User != null)
            {
                _ = await _userManager.DeleteAsync(nhanVien.User);
            }

            _ = await _context.SaveChangesAsync();
            TempData["SuccessMessage"] = "Xóa nhân viên thành công!";
            return RedirectToAction(nameof(DanhSachNhanVien));
        }
        catch (Exception ex)
        {
            TempData["ErrorMessage"] = "Có lỗi xảy ra khi xóa nhân viên: " + ex.Message;
            return RedirectToAction(nameof(DanhSachNhanVien));
        }
    }
    [HttpPost]
    public async Task<IActionResult> Create(EmployeeViewModel nhanVien)
    {
        try
        {
            if (!ModelState.IsValid)
            {
                var errors = string.Join("; ", ModelState.Values
                    .SelectMany(v => v.Errors)
                    .Select(e => e.ErrorMessage));
                return Json(new { success = false, message = "Dữ liệu không hợp lệ: " + errors });
            }

            string fileName = string.Empty;
            if (nhanVien.AnhDaiDien != null && nhanVien.AnhDaiDien.Length > 0)
            {
                fileName = Guid.NewGuid().ToString() + Path.GetExtension(nhanVien.AnhDaiDien.FileName);
                string imagesDir = Path.Combine(Directory.GetCurrentDirectory(), "wwwroot", "Image");
                _ = Directory.CreateDirectory(imagesDir);
                string filePath = Path.Combine(imagesDir, fileName);
                await using FileStream stream = new(filePath, FileMode.Create);
                await nhanVien.AnhDaiDien.CopyToAsync(stream);
            }

            ThongTinNguoiDung employee = new()
            {
                FullName = nhanVien.HoVaTen,
                GioiTinh = nhanVien.GioiTinh,
                GioiTinhStxt = nhanVien.GioiTinh.GetDescription(),
                BirthDay = nhanVien.NgaySinh,
                IdentityNumber = nhanVien.CCCD,
                DepartmentId = nhanVien.PhongBanId,
                ChucVuId = nhanVien.ChucVuId,
                NhanSuType = nhanVien.LoaiNhanSu,
                NhanSuTypeStxt = nhanVien?.LoaiNhanSu.GetDescription(),
                ImageLink = fileName
            };
            
            if (nhanVien is null)
            {
                return Json(new { success = false, message = "Dữ liệu nhân viên không hợp lệ." });
            }
            
            NguoiDung user = new()
            {
                UserName = nhanVien != null ? nhanVien.Email : string.Empty,
                Email = nhanVien != null ? nhanVien.Email : string.Empty,
                PhoneNumber = nhanVien != null ? nhanVien.SoDienThoai : string.Empty,
                MaNhanVien = nhanVien != null ? nhanVien.MaNhanVien : string.Empty,
            };

            IdentityResult result = await _userManager.CreateAsync(user, nhanVien!.MatKhau);
            if (!result.Succeeded)
            {
                return Json(new { success = false, message = string.Join("; ", result.Errors.Select(e => e.Description)) });
            }

            // assign created user's id to employee and save
            employee.UserId = user.Id;
            _ = await _context.ThongTinNguoiDungs.AddAsync(employee);
            _ = await _context.SaveChangesAsync();
            
            return Json(new { 
                success = true, 
                redirectUrl = nhanVien.LoaiNhanSu == NhanSuType.ThucTapSinh 
                    ? Url.Action("DanhSachThucTap") 
                    : Url.Action("DanhSachNhanVien")
            });
        }
        catch (Exception ex)
        {
            return Json(new { success = false, message = "Có lỗi xảy ra: " + ex.Message });
        }
    }
}
