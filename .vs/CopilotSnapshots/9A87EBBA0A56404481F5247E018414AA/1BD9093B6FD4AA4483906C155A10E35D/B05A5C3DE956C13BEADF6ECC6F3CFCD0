@model IEnumerable<QuanLyNhanLuc.Models.ViewModels.BaoHiemVM>

<div class="container-fluid">
    <div class="row mb-3">
        <div class="col-md-6">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item">
                        <a class="text-decoration-none text-secondary" href="/">
                            <i class="bi bi-house-door"></i>
                        </a>
                    </li>
                    <li class="breadcrumb-item">
                        <a class="text-decoration-none text-secondary" href="#">Nhân sự</a>
                    </li>
                    <li class="breadcrumb-item text-primary">Danh sách bảo hiểm</li>
                </ol>
            </nav>
        </div>
        <div class="col-md-6 text-end">
            <button type="button" class="btn btn-primary" data-action="create">
                <i class="bi bi-plus-circle me-1"></i>Thêm mới
            </button>
        </div>
    </div>

    <div class="card">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Mã nhân viên</th>
                            <th>Họ và tên</th>
                            <th>Phòng ban</th>
                            <th>Số BHXH</th>
                            <th>Số BHYT</th>
                            <th>Ngày tham gia</th>
                            <th>Trạng thái</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var item in Model)
                        {
                            <tr>
                                <td>@item.MaNhanVien</td>
                                <td>@item.HoTen</td>
                                <td>@item.PhongBan</td>
                                <td>@item.SoBHXH</td>
                                <td>@item.SoBHYT</td>
                                <td>@item.NgayThamGia.ToString("dd/MM/yyyy")</td>
                                <td>
                                    @if (item.DaTraTheBHYT)
                                    {
                                        <span class="badge bg-success">Đã trả thẻ</span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-warning text-dark">Chưa trả thẻ</span>
                                    }
                                </td>
                                <td class="text-end">
                                    <button class="btn btn-sm" data-action="view" data-id="@item.Id" title="Xem chi tiết">
                                        <i class="bi bi-eye text-primary"></i>
                                    </button>
                                    <button class="btn btn-sm" data-action="edit" data-id="@item.Id" title="Sửa">
                                        <i class="bi bi-pencil text-info"></i>
                                    </button>
                                    <button class="btn btn-sm" data-action="delete" data-id="@item.Id" title="Xóa">
                                        <i class="bi bi-trash text-danger"></i>
                                    </button>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Modal Thêm/Sửa Bảo hiểm -->
<div class="modal fade" id="baoHiemModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="baoHiemModalTitle">Thêm bảo hiểm</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="baoHiemForm">
                    <input type="hidden" id="bhId" name="id" />
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Nhân viên <span class="text-danger">*</span></label>
                            <select id="bhNhanSuId" name="nhanSuId" class="form-select" required>
                                <option value="">-- Chọn nhân viên --</option>
                                @foreach (var ns in ViewBag.NhanSuList as Microsoft.AspNetCore.Mvc.Rendering.SelectList ?? new Microsoft.AspNetCore.Mvc.Rendering.SelectList(new List<object>()))
                                {
                                    <option value="@ns.Value">@ns.Text</option>
                                }
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Số BHXH <span class="text-danger">*</span></label>
                            <input type="text" id="bhSoBHXH" name="soBHXH" class="form-control" required />
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Số BHXH cũ</label>
                            <input type="text" id="bhSoBHXHCu" name="soBHXHCu" class="form-control" />
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Số BHYT <span class="text-danger">*</span></label>
                            <input type="text" id="bhSoBHYT" name="soBHYT" class="form-control" required />
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Ngày tham gia</label>
                            <input type="date" id="bhNgayThamGia" name="ngayThamGia" class="form-control" />
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Ngày cấp thẻ</label>
                            <input type="date" id="bhNgayCapThe" name="ngayCapThe" class="form-control" />
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Ngày hết hạn</label>
                            <input type="date" id="bhNgayHetHan" name="ngayHetHan" class="form-control" />
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Nơi đăng ký BHXH</label>
                            <input type="text" id="bhNoiDangKyBHXH" name="noiDangKyBHXH" class="form-control" />
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Nơi đăng ký KCB</label>
                            <input type="text" id="bhNoiDangKyKCB" name="noiDangKyKCB" class="form-control" />
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Mã KCB</label>
                            <input type="text" id="bhMaKCB" name="maKCB" class="form-control" />
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Mã tỉnh bệnh viện</label>
                            <input type="text" id="bhMaTinhBenhVien" name="maTinhBenhVien" class="form-control" />
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Đã trả thẻ BHYT</label>
                            <div class="form-check mt-2">
                                <input type="checkbox" id="bhDaTraTheBHYT" name="daTraTheBHYT" value="true" class="form-check-input" />
                                <label class="form-check-label">Đã trả</label>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Ngày tham gia BHTN</label>
                            <input type="date" id="bhNgayThamGiaBHTN" name="ngayThamGiaBHTN" class="form-control" />
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Thời gian đóng BHTN (tháng)</label>
                            <input type="number" id="bhThoiGianDongBHTN" name="thoiGianDongBHTN" class="form-control" />
                        </div>
                    </div>
                    <div class="text-danger" id="bhError" style="display:none"></div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                <button type="button" id="bhSaveBtn" class="btn btn-primary">Lưu</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Xem chi tiết -->
<div class="modal fade" id="viewModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title">Chi tiết bảo hiểm</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="viewModalBody">
                <!-- Loaded via AJAX -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Xóa -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">Xác nhận xóa</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Bạn có chắc chắn muốn xóa thông tin bảo hiểm này?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" id="deleteConfirmBtn" class="btn btn-danger">Xóa</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(function() {
            var deleteId = null;

            // Create
            $("button[data-action='create']").on('click', function() {
                $('#baoHiemModalTitle').text('Thêm bảo hiểm');
                $('#baoHiemForm')[0].reset();
                $('#bhId').val('');
                $('#bhNhanSuId').prop('disabled', false);
                $('#bhError').hide();
                new bootstrap.Modal(document.getElementById('baoHiemModal')).show();
            });

            // Edit
            $(document).on('click', "button[data-action='edit']", function() {
                var id = $(this).data('id');
                $('#baoHiemModalTitle').text('Chỉnh sửa bảo hiểm');
                $('#bhError').hide();
                $.get('/BaoHiem/GetBaoHiem', { id: id }).done(function(res) {
                    $('#bhId').val(res.id);
                    $('#bhNhanSuId').val(res.nhanSuId).prop('disabled', true);
                    $('#bhSoBHXH').val(res.soBHXH);
                    $('#bhSoBHXHCu').val(res.soBHXHCu);
                    $('#bhSoBHYT').val(res.soBHYT);
                    $('#bhNgayThamGia').val(res.ngayThamGia);
                    $('#bhNgayCapThe').val(res.ngayCapThe);
                    $('#bhNgayHetHan').val(res.ngayHetHan);
                    $('#bhNoiDangKyBHXH').val(res.noiDangKyBHXH);
                    $('#bhNoiDangKyKCB').val(res.noiDangKyKCB);
                    $('#bhMaKCB').val(res.maKCB);
                    $('#bhMaTinhBenhVien').val(res.maTinhBenhVien);
                    $('#bhDaTraTheBHYT').prop('checked', res.daTraTheBHYT);
                    $('#bhNgayThamGiaBHTN').val(res.ngayThamGiaBHTN);
                    $('#bhThoiGianDongBHTN').val(res.thoiGianDongBHTN);
                    new bootstrap.Modal(document.getElementById('baoHiemModal')).show();
                });
            });

            // View
            $(document).on('click', "button[data-action='view']", function() {
                var id = $(this).data('id');
                $.get('/BaoHiem/GetBaoHiem', { id: id }).done(function(res) {
                    var html = '<div class="row">' +
                        '<div class="col-md-6"><p><strong>Số BHXH:</strong> ' + (res.soBHXH || '-') + '</p></div>' +
                        '<div class="col-md-6"><p><strong>Số BHYT:</strong> ' + (res.soBHYT || '-') + '</p></div>' +
                        '<div class="col-md-6"><p><strong>Ngày tham gia:</strong> ' + (res.ngayThamGia || '-') + '</p></div>' +
                        '<div class="col-md-6"><p><strong>Ngày cấp thẻ:</strong> ' + (res.ngayCapThe || '-') + '</p></div>' +
                        '<div class="col-md-6"><p><strong>Ngày hết hạn:</strong> ' + (res.ngayHetHan || '-') + '</p></div>' +
                        '<div class="col-md-6"><p><strong>Nơi đăng ký BHXH:</strong> ' + (res.noiDangKyBHXH || '-') + '</p></div>' +
                        '<div class="col-md-6"><p><strong>Nơi đăng ký KCB:</strong> ' + (res.noiDangKyKCB || '-') + '</p></div>' +
                        '<div class="col-md-6"><p><strong>Mã KCB:</strong> ' + (res.maKCB || '-') + '</p></div>' +
                        '<div class="col-md-6"><p><strong>Đã trả thẻ:</strong> ' + (res.daTraTheBHYT ? 'Có' : 'Chưa') + '</p></div>' +
                        '</div>';
                    $('#viewModalBody').html(html);
                    new bootstrap.Modal(document.getElementById('viewModal')).show();
                });
            });

            // Save
            $('#bhSaveBtn').on('click', function() {
                var id = $('#bhId').val();
                var url = id ? '/BaoHiem/EditAjax' : '/BaoHiem/CreateAjax';
                var formData = $('#baoHiemForm').serialize();
                if ($('#bhNhanSuId').prop('disabled')) {
                    formData += '&nhanSuId=' + $('#bhNhanSuId').val();
                }
                $.post(url, formData).done(function(res) {
                    if (res.success) location.reload();
                    else { $('#bhError').text(res.message).show(); }
                }).fail(function() { alert('Có lỗi xảy ra'); });
            });

            // Delete
            $(document).on('click', "button[data-action='delete']", function() {
                deleteId = $(this).data('id');
                new bootstrap.Modal(document.getElementById('deleteModal')).show();
            });

            $('#deleteConfirmBtn').on('click', function() {
                if (!deleteId) return;
                $.post('/BaoHiem/DeleteAjax', { id: deleteId }).done(function(res) {
                    if (res.success) location.reload();
                    else alert(res.message);
                });
            });
        });
    </script>
}